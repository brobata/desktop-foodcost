<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Dfc.Desktop.ViewModels"
        xmlns:models="using:Dfc.Core.Models"
        x:Class="Dfc.Desktop.Views.BackupManagerWindow"
        x:DataType="vm:BackupManagerViewModel"
        Title="Backup Manager"
        Width="900"
        Height="600"
        WindowStartupLocation="CenterOwner"
        Icon="/Assets/appicon.ico">

    <Design.DataContext>
        <vm:BackupManagerViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto,Auto" Margin="20">
        <!-- Header -->
        <StackPanel Grid.Row="0" Spacing="10" Margin="0,0,0,20">
            <TextBlock Text="Backup Manager"
                      FontSize="24"
                      FontWeight="Bold" />
            <TextBlock Text="Create backups of your database and photos, or restore from previous backups"
                      Foreground="Gray"
                      TextWrapping="Wrap" />
        </StackPanel>

        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="*,20,300" RowDefinitions="Auto,*">
            <!-- Backup List -->
            <StackPanel Grid.Column="0" Grid.RowSpan="2" Spacing="10">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                              Text="Available Backups"
                              FontSize="16"
                              FontWeight="SemiBold" />
                    <Button Grid.Column="1"
                           Content="Refresh"
                           Command="{Binding RefreshBackupsCommand}"
                           Padding="10,5" />
                </Grid>

                <DataGrid ItemsSource="{Binding Backups}"
                         SelectedItem="{Binding SelectedBackup}"
                         AutoGenerateColumns="False"
                         IsReadOnly="True"
                         GridLinesVisibility="Horizontal"
                         HeadersVisibility="Column"
                         Height="400">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="File Name"
                                          Binding="{Binding FileName}"
                                          Width="200" />
                        <DataGridTextColumn Header="Created"
                                          Binding="{Binding Metadata.CreatedAt, StringFormat={}{0:MM/dd/yyyy HH:mm}}"
                                          Width="130" />
                        <DataGridTemplateColumn Header="Size" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock>
                                        <Run Text="{Binding Metadata.TotalBackupSizeBytes, StringFormat={}{0:N0}}" />
                                        <Run Text=" bytes" />
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Items"
                                          Width="100">
                            <DataGridTextColumn.Binding>
                                <MultiBinding StringFormat="{}{0} / {1} / {2}">
                                    <Binding Path="Metadata.IngredientCount" />
                                    <Binding Path="Metadata.RecipeCount" />
                                    <Binding Path="Metadata.EntreeCount" />
                                </MultiBinding>
                            </DataGridTextColumn.Binding>
                        </DataGridTextColumn>
                        <DataGridCheckBoxColumn Header="Photos"
                                              Binding="{Binding Metadata.IncludesPhotos}"
                                              Width="60" />
                        <DataGridCheckBoxColumn Header="Valid"
                                              Binding="{Binding IsValid}"
                                              Width="60" />
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Backup Actions -->
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Content="Restore Selected"
                           Command="{Binding RestoreBackupCommand}"
                           Padding="15,8"
                           Background="#2196F3"
                           Foreground="White" />
                    <Button Content="Delete Selected"
                           Command="{Binding DeleteBackupCommand}"
                           Padding="15,8"
                           Background="#F44336"
                           Foreground="White" />
                    <Button Content="Open Backup Folder"
                           Command="{Binding OpenBackupDirectoryCommand}"
                           Padding="15,8" />
                </StackPanel>
            </StackPanel>

            <!-- Create Backup Panel -->
            <Border Grid.Column="2"
                   Grid.Row="0"
                   BorderBrush="LightGray"
                   BorderThickness="1"
                   CornerRadius="5"
                   Padding="15"
                   Background="#F5F5F5">
                <StackPanel Spacing="15">
                    <TextBlock Text="Create New Backup"
                              FontSize="16"
                              FontWeight="SemiBold" />

                    <StackPanel Spacing="5">
                        <CheckBox IsChecked="{Binding IncludePhotos}"
                                 Content="Include Photos" />
                        <TextBlock Text="(Backup will be larger but includes all photo files)"
                                  FontSize="11"
                                  Foreground="Gray"
                                  Margin="25,0,0,0"
                                  TextWrapping="Wrap" />
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Notes (optional):" />
                        <TextBox Text="{Binding BackupNotes}"
                                Watermark="Enter backup description..."
                                AcceptsReturn="True"
                                Height="80"
                                TextWrapping="Wrap" />
                    </StackPanel>

                    <Button Content="Create Backup"
                           Command="{Binding CreateBackupCommand}"
                           IsEnabled="{Binding !IsCreatingBackup}"
                           Padding="15,10"
                           HorizontalAlignment="Stretch"
                           Background="#4CAF50"
                           Foreground="White"
                           FontWeight="SemiBold" />

                    <Button Content="Create Automatic Backup"
                           Command="{Binding CreateAutomaticBackupCommand}"
                           IsEnabled="{Binding !IsCreatingBackup}"
                           Padding="15,10"
                           HorizontalAlignment="Stretch"
                           ToolTip.Tip="Quick backup with auto-rotation (keeps last 5)" />

                    <TextBlock Text="{Binding DefaultBackupDirectory, StringFormat='Default location: {0}'}"
                              FontSize="11"
                              Foreground="Gray"
                              TextWrapping="Wrap" />
                </StackPanel>
            </Border>

            <!-- Selected Backup Details -->
            <Border Grid.Column="2"
                   Grid.Row="1"
                   BorderBrush="LightGray"
                   BorderThickness="1"
                   CornerRadius="5"
                   Padding="15"
                   Background="#F5F5F5"
                   Margin="0,20,0,0"
                   IsVisible="{Binding SelectedBackup, Converter={x:Static ObjectConverters.IsNotNull}}">
                <StackPanel Spacing="10">
                    <TextBlock Text="Backup Details"
                              FontSize="16"
                              FontWeight="SemiBold" />

                    <StackPanel Spacing="5">
                        <TextBlock Text="File Name:" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedBackup.FileName}"
                                  TextWrapping="Wrap" />
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Created:" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedBackup.Metadata.CreatedAt, StringFormat={}{0:F}}" />
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Created By:" FontWeight="SemiBold" />
                        <TextBlock>
                            <Run Text="{Binding SelectedBackup.Metadata.Username}" />
                            <Run Text="@" />
                            <Run Text="{Binding SelectedBackup.Metadata.MachineName}" />
                        </TextBlock>
                    </StackPanel>

                    <StackPanel Spacing="5">
                        <TextBlock Text="Contents:" FontWeight="SemiBold" />
                        <StackPanel Spacing="2">
                            <TextBlock Text="{Binding SelectedBackup.Metadata.IngredientCount, StringFormat='• {0} Ingredients'}" />
                            <TextBlock Text="{Binding SelectedBackup.Metadata.RecipeCount, StringFormat='• {0} Recipes'}" />
                            <TextBlock Text="{Binding SelectedBackup.Metadata.EntreeCount, StringFormat='• {0} Entrees'}" />
                            <TextBlock Text="{Binding SelectedBackup.Metadata.PhotoCount, StringFormat='• {0} Photos'}"
                                      IsVisible="{Binding SelectedBackup.Metadata.IncludesPhotos}" />
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Spacing="5"
                               IsVisible="{Binding SelectedBackup.Metadata.Notes, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                        <TextBlock Text="Notes:" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding SelectedBackup.Metadata.Notes}"
                                  TextWrapping="Wrap" />
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Progress Bar -->
        <Border Grid.Row="2"
               IsVisible="{Binding ShowProgress}"
               BorderBrush="LightGray"
               BorderThickness="1"
               CornerRadius="5"
               Padding="15"
               Margin="0,20,0,0"
               Background="#E3F2FD">
            <StackPanel Spacing="10">
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                              Text="{Binding ProgressMessage}"
                              FontWeight="SemiBold" />
                    <TextBlock Grid.Column="1"
                              Text="{Binding ProgressPercent, StringFormat='{}{0}%'}"
                              FontWeight="SemiBold" />
                </Grid>
                <ProgressBar Value="{Binding ProgressPercent}"
                            Minimum="0"
                            Maximum="100"
                            Height="10" />
                <Button Content="Cancel"
                       Command="{Binding CancelOperationCommand}"
                       IsVisible="{Binding CanCancel}"
                       Padding="10,5"
                       HorizontalAlignment="Right" />
            </StackPanel>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3"
               BorderBrush="LightGray"
               BorderThickness="1"
               CornerRadius="5"
               Padding="10"
               Margin="0,10,0,0"
               Background="#FFFDE7"
               IsVisible="{Binding StatusMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
            <TextBlock Text="{Binding StatusMessage}"
                      TextWrapping="Wrap" />
        </Border>
    </Grid>
</Window>
