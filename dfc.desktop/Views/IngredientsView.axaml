<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Dfc.Desktop.ViewModels"
             xmlns:converters="using:Dfc.Desktop.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1000" d:DesignHeight="700"
             x:Class="Dfc.Desktop.Views.IngredientsView"
             x:DataType="vm:IngredientsViewModel">

	<UserControl.Resources>
		<converters:CategoryColorConverter x:Key="CategoryColorConverter"/>
	</UserControl.Resources>

	<Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,*">

		<StackPanel Grid.Row="0" Spacing="8" Margin="0,0,0,16">
			<TextBlock Text="Ingredients"
                       FontSize="28"
                       FontWeight="Bold"
                       Foreground="#2D2D2D"/>
			<TextBlock Text="Manage your ingredient inventory and pricing"
                       FontSize="14"
                       Foreground="#666"/>
		</StackPanel>

		<!-- Validation Warnings -->
		<Border Grid.Row="1"
		        IsVisible="{Binding ValidationWarningCount}"
		        Background="#FFF3E0"
		        CornerRadius="8"
		        Padding="16"
		        Margin="0,0,0,16">
			<Grid ColumnDefinitions="Auto,*">
				<TextBlock Grid.Column="0"
				          Text="âš ï¸"
				          FontSize="24"
				          VerticalAlignment="Center"
				          Margin="0,0,16,0"/>
				<StackPanel Grid.Column="1" Spacing="4">
					<TextBlock Text="{Binding ValidationWarningCount, StringFormat='{}{0} items need attention'}"
					          FontSize="14"
					          FontWeight="Bold"
					          Foreground="#E65100"/>
					<StackPanel Orientation="Horizontal" Spacing="16">
						<TextBlock Text="{Binding MissingPrices, StringFormat='Missing prices: {0}'}"
						          FontSize="12"
						          Foreground="#666"
						          IsVisible="{Binding MissingPrices}"/>
						<TextBlock Text="{Binding MissingVendors, StringFormat='No vendor: {0}'}"
						          FontSize="12"
						          Foreground="#666"
						          IsVisible="{Binding MissingVendors}"/>
						<TextBlock Text="{Binding MissingCategories, StringFormat='No category: {0}'}"
						          FontSize="12"
						          Foreground="#666"
						          IsVisible="{Binding MissingCategories}"/>
					</StackPanel>
				</StackPanel>
			</Grid>
		</Border>

		<!-- Stats Panel -->
		<Border Grid.Row="2"
		        Background="White"
		        CornerRadius="8"
		        Padding="16"
		        Margin="0,0,0,16"
		        BoxShadow="0 2 8 0 #10000000">
			<Grid ColumnDefinitions="*,*,*,*">
				<StackPanel Grid.Column="0" Spacing="4">
					<TextBlock Text="Total" FontSize="12" Foreground="#999"/>
					<TextBlock Text="{Binding TotalIngredients}" FontSize="24" FontWeight="Bold" Foreground="#2D2D2D"/>
				</StackPanel>
				<StackPanel Grid.Column="1" Spacing="4">
					<TextBlock Text="Valid" FontSize="12" Foreground="#999"/>
					<StackPanel Orientation="Horizontal" Spacing="4">
						<TextBlock Text="{Binding ValidIngredients}" FontSize="24" FontWeight="Bold" Foreground="#4CAF50"/>
						<TextBlock Text="âœ“" FontSize="20" Foreground="#4CAF50" VerticalAlignment="Center"/>
					</StackPanel>
				</StackPanel>
				<StackPanel Grid.Column="2" Spacing="4">
					<TextBlock Text="Avg Price" FontSize="12" Foreground="#999"/>
					<TextBlock Text="{Binding AveragePrice, StringFormat='{}{0:C2}'}" FontSize="24" FontWeight="Bold" Foreground="#2196F3"/>
				</StackPanel>
				<StackPanel Grid.Column="3" Spacing="4">
					<TextBlock Text="Categories" FontSize="12" Foreground="#999"/>
					<TextBlock Text="{Binding UniqueCategories}" FontSize="24" FontWeight="Bold" Foreground="#9C27B0"/>
				</StackPanel>
			</Grid>
		</Border>

		<Border Grid.Row="3"
                Background="White"
                CornerRadius="8"
                Padding="16"
                Margin="0,0,0,16"
                BoxShadow="0 2 8 0 #10000000">
			<Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
				<ComboBox Grid.Column="0"
				         ItemsSource="{Binding QuickFilterOptions}"
				         SelectedItem="{Binding SelectedQuickFilter}"
				         MinWidth="140"
				         VerticalAlignment="Center"
				         ToolTip.Tip="Quick filters">
					<ComboBox.ItemTemplate>
						<DataTemplate>
							<TextBlock Text="{Binding}" FontSize="12"/>
						</DataTemplate>
					</ComboBox.ItemTemplate>
				</ComboBox>
				<TextBox Grid.Column="1"
                         Text="{Binding SearchText}"
                         Watermark="Search ingredients..."
                         MinWidth="300"
                         VerticalAlignment="Center"/>
				<StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="8">
					<!-- Batch Operations Panel -->
					<Border IsVisible="{Binding SelectedIngredients.Count}"
					        Background="#FFF3E0"
					        CornerRadius="4"
					        Padding="12,8"
					        Margin="0,0,8,0">
						<StackPanel Orientation="Horizontal" Spacing="8">
							<TextBlock Text="{Binding SelectedIngredients.Count, StringFormat='{}{0} selected'}"
							          FontWeight="SemiBold"
							          VerticalAlignment="Center"
							          Foreground="#E65100"/>
							<Button Content="âœ“ All"
							        Command="{Binding SelectAllCommand}"
							        Background="#FFB74D"
							        Foreground="White"
							        Padding="8,4"
							        CornerRadius="3"
							        FontSize="11"/>
							<Button Content="âœ• Clear"
							        Command="{Binding ClearSelectionCommand}"
							        Background="#90A4AE"
							        Foreground="White"
							        Padding="8,4"
							        CornerRadius="3"
							        FontSize="11"/>
							<Button Content="ðŸ“‹ Duplicate"
							        Command="{Binding BatchDuplicateCommand}"
							        Background="#64B5F6"
							        Foreground="White"
							        Padding="8,4"
							        CornerRadius="3"
							        FontSize="11"
							        ToolTip.Tip="Duplicate selected ingredients (Ctrl+D)"/>
							<Button Content="ðŸ—‘ï¸ Delete"
							        Command="{Binding BatchDeleteCommand}"
							        Background="#EF5350"
							        Foreground="White"
							        Padding="8,4"
							        CornerRadius="3"
							        FontSize="11"
							        ToolTip.Tip="Delete selected ingredients (Delete key)"/>
						</StackPanel>
					</Border>
					<Button Content="ðŸ” Filters"
                            Background="#B39DDB"
                            Foreground="White"
                            Padding="16,8"
                            CornerRadius="4"
                            FontWeight="SemiBold">
						<Button.Flyout>
							<Flyout Placement="Bottom">
								<StackPanel Width="250" Spacing="12">
									<TextBlock Text="Filter by Allergen"
									          FontWeight="Bold"
									          FontSize="14"
									          Foreground="#2D2D2D"/>
									<ScrollViewer MaxHeight="300"
									             HorizontalScrollBarVisibility="Disabled"
									             VerticalScrollBarVisibility="Auto">
										<ItemsControl ItemsSource="{Binding AvailableAllergens}">
											<ItemsControl.ItemTemplate>
												<DataTemplate>
													<CheckBox Content="{Binding Name}"
													         IsChecked="{Binding IsSelected}"
													         Margin="0,0,0,8"
													         FontSize="12"/>
												</DataTemplate>
											</ItemsControl.ItemTemplate>
										</ItemsControl>
									</ScrollViewer>
									<Button Content="Clear All"
									       Command="{Binding ClearAllFiltersCommand}"
									       Background="#EF9A9A"
									       Foreground="White"
									       Padding="12,6"
									       CornerRadius="4"
									       HorizontalAlignment="Stretch"
									       FontWeight="SemiBold"/>
								</StackPanel>
							</Flyout>
						</Button.Flyout>
					</Button>
				</StackPanel>
			</Grid>
		</Border>

		<!-- Action Buttons Row -->
		<Border Grid.Row="4"
		        Background="White"
		        CornerRadius="8"
		        Padding="16"
		        Margin="0,0,0,16"
		        BoxShadow="0 2 8 0 #10000000">
			<StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Left">
				<Button Content="âž• Add Ingredient"
				        Command="{Binding AddIngredientCommand}"
				        Background="#7AB51D"
				        Foreground="White"
				        Padding="16,8"
				        CornerRadius="4"
				        FontWeight="SemiBold"
				        ToolTip.Tip="Add new ingredient (Insert key)"/>
				<Button Content="ðŸšš Bulk Import from Vendor"
				        Command="{Binding BulkImportCommand}"
				        Background="#90CAF9"
				        Foreground="White"
				        Padding="16,8"
				        CornerRadius="4"
				        FontWeight="SemiBold"
				        ToolTip.Tip="Import ingredient pricing from vendor files (Sysco, US Foods, etc.)"/>
				<Button Command="{Binding BulkMapNutritionalDataCommand}"
				        Background="#4CAF50"
				        Foreground="White"
				        Padding="16,8"
				        CornerRadius="4"
				        FontWeight="SemiBold"
				        ToolTip.Tip="Auto-fill nutritional data from USDA database">
					<Panel>
						<TextBlock Text="ðŸŒ Bulk Map Nutritional Data" IsVisible="{Binding MissingNutritionalData}"/>
						<TextBlock Text="ðŸŒ Update Nutritional Data" IsVisible="{Binding !MissingNutritionalData}"/>
					</Panel>
				</Button>
			</StackPanel>
		</Border>

		<Border Grid.Row="5"
                Background="White"
                CornerRadius="8"
                BoxShadow="0 2 8 0 #10000000"
                Padding="16">
			<Grid>
				<Border IsVisible="{Binding IsLoading}"
				        Background="#80FFFFFF"
				        ZIndex="100">
					<StackPanel VerticalAlignment="Center"
					           HorizontalAlignment="Center"
					           Spacing="16">
						<TextBlock Text="â³"
						          FontSize="48"
						          HorizontalAlignment="Center"/>
						<TextBlock Text="Loading ingredients..."
						          FontSize="16"
						          HorizontalAlignment="Center"
						          Foreground="#666"/>
					</StackPanel>
				</Border>

				<DataGrid Name="IngredientsDataGrid"
				         ItemsSource="{Binding Ingredients}"
				         IsVisible="{Binding Ingredients.Count}"
			          SelectedItem="{Binding SelectedIngredient}"
			          AutoGenerateColumns="False"
			          IsReadOnly="True"
			          GridLinesVisibility="Horizontal"
			          CanUserResizeColumns="True"
			          CanUserSortColumns="True"
			          SelectionMode="Extended"
			          SelectionChanged="OnSelectionChanged"
			          DoubleTapped="OnDataGridDoubleTapped"
			          KeyDown="OnDataGridKeyDown">

					<DataGrid.Columns>
						<DataGridTemplateColumn Header="âœ“" Width="50" IsReadOnly="True">
							<DataGridTemplateColumn.CellTemplate>
								<DataTemplate>
									<TextBlock Text="{Binding StatusIcon}"
											  FontSize="16"
											  VerticalAlignment="Center"
											  HorizontalAlignment="Center"
											  Foreground="{Binding StatusColor}"
											  ToolTip.Tip="{Binding StatusTooltip}"/>
								</DataTemplate>
							</DataGridTemplateColumn.CellTemplate>
						</DataGridTemplateColumn>

						<DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="4*"/>

						<DataGridTextColumn Header="Alias" Binding="{Binding Alias}" Width="1.5*"/>
						<DataGridTextColumn Header="Supplier" Binding="{Binding Supplier}" Width="1.5*"/>
						<DataGridTextColumn Header="SKU" Binding="{Binding SKU}" Width="1.2*"/>
						<DataGridTextColumn Header="Price" Binding="{Binding Price}" Width="1*"/>
						<DataGridTextColumn Header="Quantity" Binding="{Binding Quantity}" Width="1*"/>
						<DataGridTextColumn Header="Unit" Binding="{Binding Unit}" Width="0.8*"/>

						<DataGridTemplateColumn Header="Actions" Width="180" IsReadOnly="True">
							<DataGridTemplateColumn.CellTemplate>
								<DataTemplate>
									<StackPanel Orientation="Horizontal" Spacing="4" Margin="8,0,24,0" VerticalAlignment="Center">
										<Button Content="âœï¸"
												Command="{Binding $parent[DataGrid].((vm:IngredientsViewModel)DataContext).EditIngredientCommand}"
												CommandParameter="{Binding Ingredient}"
												Background="Transparent"
												BorderThickness="0"
												ToolTip.Tip="Edit ingredient">
											<Button.Styles>
												<Style Selector="Button:pointerover">
													<Setter Property="Background" Value="#E8F5E9"/>
												</Style>
											</Button.Styles>
										</Button>
										<Button Content="ðŸ“‹"
												Command="{Binding $parent[DataGrid].((vm:IngredientsViewModel)DataContext).DuplicateIngredientCommand}"
												CommandParameter="{Binding Ingredient}"
												Background="Transparent"
												BorderThickness="0"
												ToolTip.Tip="Duplicate ingredient">
											<Button.Styles>
												<Style Selector="Button:pointerover">
													<Setter Property="Background" Value="#E3F2FD"/>
												</Style>
											</Button.Styles>
										</Button>
										<Button Content="ðŸ“Š"
												Command="{Binding $parent[DataGrid].((vm:IngredientsViewModel)DataContext).ViewPriceHistoryCommand}"
												CommandParameter="{Binding Ingredient}"
												Background="Transparent"
												BorderThickness="0"
												ToolTip.Tip="View price history">
											<Button.Styles>
												<Style Selector="Button:pointerover">
													<Setter Property="Background" Value="#FFF9C4"/>
												</Style>
											</Button.Styles>
										</Button>
										<Button Content="ðŸ—‘ï¸"
												Command="{Binding $parent[DataGrid].((vm:IngredientsViewModel)DataContext).DeleteIngredientCommand}"
												CommandParameter="{Binding Ingredient}"
												Background="Transparent"
												BorderThickness="0"
												ToolTip.Tip="Delete ingredient">
											<Button.Styles>
												<Style Selector="Button:pointerover">
													<Setter Property="Background" Value="#FFEBEE"/>
												</Style>
											</Button.Styles>
										</Button>
									</StackPanel>
								</DataTemplate>
							</DataGridTemplateColumn.CellTemplate>
						</DataGridTemplateColumn>
					</DataGrid.Columns>
				</DataGrid>

				<!-- Loading Indicator -->
				<StackPanel IsVisible="{Binding IsLoading}"
				           VerticalAlignment="Center"
				           HorizontalAlignment="Center"
				           Spacing="16">
					<ProgressBar IsIndeterminate="True"
					            Width="200"
					            Foreground="#7AB51D"/>
					<TextBlock Text="Loading ingredients..."
					          FontSize="14"
					          Foreground="#999"
					          HorizontalAlignment="Center"/>
				</StackPanel>

				<!-- Empty State -->
				<StackPanel IsVisible="{Binding !Ingredients.Count}"
				           VerticalAlignment="Center"
				           HorizontalAlignment="Center"
				           Spacing="16"
				           Margin="0,80,0,0">
					<TextBlock Text="ðŸ¥•"
					          FontSize="64"
					          HorizontalAlignment="Center"
					          Opacity="0.3"/>
					<TextBlock Text="No ingredients yet"
					          FontSize="20"
					          FontWeight="SemiBold"
					          HorizontalAlignment="Center"
					          Foreground="#999"/>
					<TextBlock Text="Click 'Add Ingredient' to get started, or import from Excel"
					          FontSize="14"
					          HorizontalAlignment="Center"
					          Foreground="#AAA"
					          TextWrapping="Wrap"
					          TextAlignment="Center"
					          MaxWidth="300"/>
					<Button Content="âž• Add Your First Ingredient"
					       Command="{Binding AddIngredientCommand}"
					       Background="#7AB51D"
					       Foreground="White"
					       Padding="16,10"
					       CornerRadius="6"
					       FontWeight="SemiBold"
					       HorizontalAlignment="Center"
					       Margin="0,8,0,0"/>
				</StackPanel>
			</Grid>
		</Border>
	</Grid>
</UserControl>