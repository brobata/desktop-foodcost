name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.9.010625)'
        required: true
        default: '0.9.010625'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            artifact: windows
          - os: macos-latest
            runtime: osx-x64
            artifact: macos-intel
          - os: macos-latest
            runtime: osx-arm64
            artifact: macos-arm
          - os: ubuntu-latest
            runtime: linux-x64
            artifact: linux

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    - name: Update version in project
      shell: bash
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        sed -i.bak "s|<Version>.*</Version>|<Version>$VERSION</Version>|" dfc.desktop/dfc.desktop.csproj
        sed -i.bak "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$VERSION.0</AssemblyVersion>|" dfc.desktop/dfc.desktop.csproj
        sed -i.bak "s|<FileVersion>.*</FileVersion>|<FileVersion>$VERSION.0</FileVersion>|" dfc.desktop/dfc.desktop.csproj
        sed -i.bak "s|<InformationalVersion>.*</InformationalVersion>|<InformationalVersion>$VERSION</InformationalVersion>|" dfc.desktop/dfc.desktop.csproj

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Run tests
      run: dotnet test --no-restore --verbosity normal
      continue-on-error: true

    - name: Publish
      run: |
        dotnet publish dfc.desktop/dfc.desktop.csproj \
          --configuration Release \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          -p:PublishSingleFile=false \
          -p:IncludeNativeLibrariesForSelfExtract=true

    - name: Create zip (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        Compress-Archive -Path ./publish/${{ matrix.runtime }}/* -DestinationPath "./DesktopFoodCost-v$version-${{ matrix.runtime }}-portable.zip"

    - name: Create zip (macOS/Linux)
      if: matrix.os != 'windows-latest'
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        cd ./publish/${{ matrix.runtime }}
        chmod +x dfc.desktop
        zip -r "../../DesktopFoodCost-v$VERSION-${{ matrix.runtime }}.zip" .

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: ./DesktopFoodCost-v*.zip

  build-installer:
    runs-on: windows-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    - name: Restore and publish
      run: |
        dotnet restore
        dotnet publish dfc.desktop/dfc.desktop.csproj `
          --configuration Release `
          --runtime win-x64 `
          --self-contained true `
          --output ./publish/win-x64 `
          -p:PublishSingleFile=false `
          -p:IncludeNativeLibrariesForSelfExtract=true

    - name: Install Inno Setup via Chocolatey
      shell: pwsh
      run: |
        choco install innosetup --yes --no-progress

    - name: Download VC++ Redistributable
      shell: pwsh
      run: |
        $ProgressPreference = 'SilentlyContinue'
        New-Item -ItemType Directory -Force -Path "./installer"
        Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "./installer/vc_redist.x64.exe"

    - name: Create Inno Setup script
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $script = @"
        #define MyAppName "Desktop Food Cost"
        #define MyAppVersion "$version"
        #define MyAppPublisher "Desktop Food Cost"
        #define MyAppURL "https://github.com/brobata/desktop-foodcost"
        #define MyAppExeName "dfc.desktop.exe"

        [Setup]
        AppId={{8F9A7B2C-3D4E-5F6A-7B8C-9D0E1F2A3B4C}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        AppSupportURL={#MyAppURL}
        AppUpdatesURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        DefaultGroupName={#MyAppName}
        AllowNoIcons=yes
        LicenseFile=LICENSE.txt
        OutputDir=installer\output
        OutputBaseFilename=DesktopFoodCost-v{#MyAppVersion}-win-x64-Setup
        Compression=lzma
        SolidCompression=yes
        WizardStyle=modern
        PrivilegesRequired=lowest
        ArchitecturesAllowed=x64compatible
        ArchitecturesInstallIn64BitMode=x64compatible
        DisableProgramGroupPage=yes
        UsePreviousAppDir=yes
        CloseApplications=yes
        CloseApplicationsFilter=*.exe
        RestartApplications=no

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "publish\win-x64\{#MyAppExeName}"; DestDir: "{app}"; Flags: ignoreversion
        Source: "publish\win-x64\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        Source: "installer\vc_redist.x64.exe"; DestDir: "{tmp}"; Flags: ignoreversion deleteafterinstall
        Source: "LICENSE.txt"; DestDir: "{app}"; Flags: ignoreversion

        [Icons]
        Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
        Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

        [Code]
        function VCRedistNeedsInstall: Boolean;
        var
          Version: String;
        begin
          if RegQueryStringValue(HKEY_LOCAL_MACHINE,
            'SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64', 'Version', Version) then
            Result := False
          else
            Result := True;
        end;

        [Run]
        Filename: "{tmp}\vc_redist.x64.exe"; Parameters: "/quiet /norestart"; StatusMsg: "Installing Visual C++ Runtime..."; Flags: runhidden; Check: VCRedistNeedsInstall
        Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, '&', '&&')}}"; Flags: nowait postinstall skipifsilent
        "@
        Set-Content -Path "setup.iss" -Value $script

    - name: Create installer output directory
      run: mkdir -p installer/output
      shell: bash

    - name: Build installer
      shell: cmd
      run: |
        "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: installer
        path: ./installer/output/*.exe

  release:
    runs-on: ubuntu-latest
    needs: [build, build-installer]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts
      run: find artifacts -type f

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.zip
          artifacts/**/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
